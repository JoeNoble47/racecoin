{% extends "base.html" %}

{% block title %}Results - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .results-container {
        background: rgba(255,255,255,0.97);
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(60,60,60,0.13);
        padding: 2.5rem;
        margin: 2rem auto;
        max-width: 900px;
    }
    .table {
        background: rgba(255,255,255,0.95);
        color: #222;
        border-radius: 8px;
        overflow: hidden;
    }
    .table thead th {
        background: var(--racecoin-accent);
        color: #1d3557;
        font-size: 1.08rem;
        border-bottom: 2.5px solid #2e5d2e;
    }
    .table-striped>tbody>tr:nth-of-type(odd)>* {
        background-color: #f6f8e6;
    }
    .table-striped>tbody>tr:nth-of-type(even)>* {
        background-color: #fdfcf7;
    }
    .coins-badge {
        background: #90be6d;
        color: #1b3a1a;
        font-size: 1.1rem;
        padding: 0.4em 1em;
        border-radius: 1em;
        margin-bottom: 1.3em;
        display: inline-block;
    }
    .stats-badge-group span {
        margin: 0 2px 4px 2px;
        font-size: 0.98rem;
    }
    .odds-badge {
        background: var(--racecoin-accent);
        color: #1b3a1a;
        border-radius: 1em;
        padding: 0.18em 0.7em;
        font-size: 1em;
        font-weight: bold;
        margin-left: 0.5em;
    }
    .fav-star {
        color: var(--racecoin-accent);
        font-size: 1.1em;
        margin-right: 0.1em;
    }
    .stats-card {
        background: #233a23 !important;
        color: var(--racecoin-accent) !important;
        border: 1px solid var(--racecoin-accent);
    }
    .winnings-positive {
        color: #28a745;
        font-weight: bold;
    }
    .winnings-zero {
        color: #dc3545;
    }
    @media (max-width: 700px) {
        .results-container { 
            padding: 1.5rem 1rem; 
            margin: 1rem 0.5rem;
        }
        .table th, .table td { font-size: 0.95rem; }
        .hide-mobile { display: none !important; }
        .odds-badge { font-size: 1.07em; padding: 0.13em 0.5em; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-4">
        {% if results and results|length > 0 %}
            {% set first_race = results[0].race_id %}
            {% set first_winner = results[0].winner %}
            <h2 class="racecoin-glow">üèÅ Race Results üèÅ</h2>
            <p class="text-muted">Winner: <strong>{{ first_winner }}</strong></p>
        {% else %}
            <h2 class="racecoin-glow">üèÅ Race Results üèÅ</h2>
            <p class="text-muted">Your betting history and outcomes</p>
        {% endif %}
    </div>
    
    <div class="results-container">
        <div class="text-center coins-badge">
            <strong>{{ currency_name }}:</strong> {{ coins }} {{ currency_symbol }}
        </div>
        
        {% if user_stats %}
        <div class="text-center mb-3">
            <a class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" href="#userStatsCollapse" role="button" aria-expanded="false" aria-controls="userStatsCollapse">
                Show My Stats
            </a>
        </div>
        <div class="collapse mb-3" id="userStatsCollapse">
            <div class="card card-body stats-card" style="max-width: 420px; margin: 0 auto;">
                <div class="stats-badge-group">
                    <span class="badge bg-success">Wins: {{ user_stats['wins'] }}</span>
                    <span class="badge bg-info text-dark">Streak: {{ user_stats['current_streak'] }}</span>
                    <span class="badge bg-warning text-dark">Longest: {{ user_stats['longest_streak'] }}</span>
                    <span class="badge bg-primary">Acca Max: {{ user_stats['highest_accumulator'] }}</span>
                    <span class="badge bg-secondary">Bets: {{ user_stats['total_bets'] }}</span>
                    <span class="badge bg-danger">Biggest Win: {{ user_stats['biggest_single_win'] }}</span>
                </div>
                <div class="mt-2" style="font-size:0.97rem;">
                    <span>Win Rate:</span>
                    <strong>
                        {% if user_stats['total_bets'] > 0 %}
                            {{ (user_stats['wins'] / user_stats['total_bets'] * 100) | round(1) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </strong>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-bordered mt-3">
                <thead>
                    <tr>
                        <th>Race</th>
                        <th class="hide-mobile">Bet Type</th>
                        <th>Your Selection</th>
                        <th class="hide-mobile">Bet</th>
                        <th>Odds</th>
                        <th class="hide-mobile">Outcome</th>
                        <th>Winnings</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in results %}
                    <tr>
                        <td>{{ r.race_id }}</td>
                        <td class="hide-mobile">
                            {% if r.bet_type == "Win" %}
                                Win
                            {% elif r.bet_type == "Forecast" %}
                                Forecast
                            {% elif r.bet_type == "Multi" %}
                                Accumulator
                            {% else %}
                                {{ r.bet_type }}
                            {% endif %}
                        </td>
                        <td>
                            {% if r.bet_type == "Win" %}
                                {% if r.is_favourite %}<span class="fav-star">‚òÖ</span>{% endif %}
                                {{ r.horse }}
                            {% elif r.bet_type == "Forecast" %}
                                1st: <strong>{{ r.forecast_first }}</strong><br>
                                2nd: <strong>{{ r.forecast_second }}</strong>
                            {% elif r.bet_type == "Multi" and r.user_selections %}
                                {% for pick in r.user_selections %}
                                    Race {{ loop.index }}: {{ pick }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                {{ r.horse }}
                            {% endif %}
                        </td>
                        <td class="hide-mobile">{{ r.amount }}</td>
                        <td>
                            {% if r.fractional_odds %}
                                <span class="odds-badge">{{ r.fractional_odds }}</span>
                            {% else %}
                                {{ r.odds }}
                            {% endif %}
                        </td>
                        <td class="hide-mobile">
                            {% if r.won %}
                                <span class="text-success fw-bold">Won</span>
                            {% else %}
                                <span class="text-danger fw-bold">Lost</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.win_amount > 0 %}
                                <span class="winnings-positive">+{{ r.win_amount }} {{ currency_symbol }}</span>
                            {% else %}
                                <span class="winnings-zero">0 {{ currency_symbol }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-4">
            <a href="{{ url_for('profile') }}" class="btn btn-info me-2">Profile</a>
            <a href="{{ url_for('leaderboard') }}" class="btn btn-warning me-2">üèÜ Leaderboard</a>
            <a href="{{ url_for('races') }}" class="btn btn-secondary me-2">Back to Races</a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
        </div>
    </div>
</div>
{% endblock %}


